# Christopher MJ Gray  | Product Management Engineer - SP | NA   | F5 Networks | 609 310 1747      | cgray@f5.com     | https://github.com/c2theg/F5_DDoS_BP
# Updated: 1/21/2020
# Version: 1.0.2
# tmsh show running-config security firewall rule-list
# tmsh show running-config security dos profile 
#---------------------------------------------------------------------------------------------------------------------------------------------
security firewall rule-list DDoS_RuleLists_Drop {
    description "Rule lists that are more advance then basic firewall rules"
    rules {
        IPI_Accept {
            action accept
            description "IP Feed of valid sources"
            ip-protocol any
            rule-number 1
            service-policy DDoS_ServicePolicy_Main
            source {
                ipi-category {
                    DDoS_Whitelisted
                }
            }
        }
        Bogons {
            action drop
            description "Block Bogon Addresses (basic)"
            ip-protocol any
            log yes
            rule-number 2
            service-policy DDoS_ServicePolicy_Main
            uuid 01b721ff-d88c-52a1-728e-160b9994c4f2
            source {
                address-lists {
                    Bogons
                }
            }
        }
        ICMP_Blocks {
            action drop
            description "Block various ICMP types"
            ip-protocol icmp
            log yes
            rule-number 3
            uuid 01baa05d-3317-52a1-728e-160b052b8600
            icmp {
                3 { }
                3:1 { }
                3:3 { }
                3:4 { }
            }
        }
        IPI_Block {
            action drop
            description "IP Feed of Bad Sources"
            ip-protocol any
            log yes
            rule-number 4
            service-policy DDoS_ServicePolicy_Main
            source {
                ipi-category {
                    DDoS_Attack_IPs
                    DDoS_Blacklisted
                    DDoS_Bogons
                    tor_proxy
                }
            }
        }
    }
}


security firewall policy DDoS_FW_Parent {
    description "Generic policy for DDoS - https://www.us-cert.gov/ncas/alerts/TA14-017A"
    rules {
        FW_Rule0 {
            description "Dynamically updated advance firewall policies.  *** THIS SHOULD BE MODIFIED FOR YOUR USE CASE *** "
            rule-list DDoS_RuleLists_Accept
            rule-number 1
        }
        _Common_DDoS_RuleLists_1 {
            description "Advance rule-lists which are more complex then basic firewall rules"
            rule-list DDoS_RuleLists_1
            rule-number 2
        }
        FW_Rule1 {
            description "Drop ICMP and Bogons}"
            rule-list DDoS_RuleLists_Drop
            rule-number 3
        }
        FW_Rule2 {
            description "Dynamically updated advance firewall policies."
            rule-list DDoS_RuleLists_Drop_2
            rule-number 4
        }
        FW_Rule3 {
            description "Geolocation blocks. *** THIS SHOULD BE MODIFIED FOR YOUR USE CASE *** "
            rule-list DDoS_RuleLists_Drop_Geo
            rule-number 5
            uuid 015b38a9-ca4c-52a1-728e-160bfe287fa6
        }
        Memcached_TCP {
            action drop
            description "TCP version - https://en.wikipedia.org/wiki/Memcached"
            ip-protocol tcp
            log yes
            rule-number 6
            service-policy DDoS_ServicePolicy_Main
            destination {
                ports {
                    memcache { }
                }
            }
        }
        Apple_Remote_Desktop {
            action drop
            description https://en.wikipedia.org/wiki/Apple_Remote_Desktop
            ip-protocol udp
            log yes
            rule-number 7
            service-policy DDoS_ServicePolicy_Main
            destination {
                ports {
                    net-assistant { }
                }
            }
        }
        Xbox-Live {
            action drop
            description https://support.xbox.com/en-US/xbox-one/networking/network-ports-used-xbox-live
            ip-protocol udp
            log yes
            rule-number 8
            service-policy DDoS_ServicePolicy_Main
            destination {
                ports {
                    ipsec-nat-t { }
                    isakmp { }
                    kerberos { }
                    teredo { }
                    xbox { }
                }
            }
        }
        _Common_DDoS_RuleLists_2 {
            description "Advance rule-lists which are more complex then basic firewall rules"
            rule-list DDoS_RuleLists_2
            rule-number 9
        }
        Block_malicious_countries {
            action drop
            description "Block known bad countries. *** THIS SHOULD BE MODIFIED FOR YOUR USE CASE ***"
            ip-protocol any
            log yes
            rule-number 10
            source {
                geo {
                    CN { }
                    HK { }
                    RU { }
                }
            }
        }
        mDNS {
            action drop
            description "Multicast DNS"
            ip-protocol udp
            log yes
            rule-number 11
            source {
                ports {
                    mdns { }
                }
            }
        }
        Steam_Protocol {
            action drop
            ip-protocol udp
            log yes
            rule-number 12
            source {
                ports {
                    27015 { }
                }
            }
        }
        Portmap {
            action drop
            description "RPC bind reflection DDoS attack"
            ip-protocol udp
            log yes
            rule-number 13
            source {
                ports {
                    sunrpc { }
                }
            }
        }
        Bittorrent {
            action drop
            ip-protocol udp
            log yes
            rule-number 14
        }
        Memcached {
            action drop
            description https://en.wikipedia.org/wiki/Memcached
            ip-protocol udp
            log yes
            rule-number 15
            source {
                ports {
                    memcache { }
                }
            }
        }
        Memcached-t {
            action drop
            description https://en.wikipedia.org/wiki/Memcached
            ip-protocol tcp
            log yes
            rule-number 16
            source {
                ports {
                    memcache { }
                }
            }
        }
        NTP {
            action drop
            description https://en.wikipedia.org/wiki/NTP_server_misuse_and_abuse
            ip-protocol udp
            log yes
            rule-number 17
            source {
                ports {
                    ntp { }
                }
            }
        }
        Chargen {
            action drop
            description "Character Generator Protocol  https://en.wikipedia.org/wiki/Character_Generator_Protocol"
            ip-protocol udp
            log yes
            rule-number 18
            source {
                ports {
                    chargen { }
                }
            }
        }
        QOTD {
            action drop
            description "Quote of the Day  https://en.wikipedia.org/wiki/QOTD"
            ip-protocol udp
            log yes
            rule-number 19
            source {
                ports {
                    qotd { }
                }
            }
        }
        RIPv1 {
            action drop
            description https://en.wikipedia.org/wiki/Routing_Information_Protocol
            ip-protocol udp
            log yes
            rule-number 20
            source {
                ports {
                    520 { }
                }
            }
        }
        CLDAP {
            action drop
            description https://www.f5.com/labs/articles/threat-intelligence/old-protocols-new-exploits-ldap-unwittingly-serves-ddos-amplification-attacks-22609
            ip-protocol udp
            log yes
            rule-number 21
            source {
                ports {
                    ldap { }
                }
            }
        }
        TFTP {
            action drop
            description https://en.wikipedia.org/wiki/Trivial_File_Transfer_Protocol
            ip-protocol udp
            log yes
            rule-number 22
            source {
                ports {
                    tftp { }
                }
            }
        }
        SSDP {
            action drop
            description "Simple Service Discovery Protocol  https://en.wikipedia.org/wiki/Simple_Service_Discovery_Protocol"
            ip-protocol udp
            log yes
            rule-number 23
            source {
                ports {
                    ssdp { }
                }
            }
        }
        Quake {
            action drop
            description https://www.us-cert.gov/ncas/alerts/TA14-017A
            ip-protocol udp
            log yes
            rule-number 24
            source {
                ports {
                    27960 { }
                    28915 { }
                    mdqs { }
                    quake { }
                }
            }
        }
        Kad {
            action drop
            description P2P
            ip-protocol udp
            log yes
            rule-number 25
            source {
                ports {
                    kerberos_master { }
                }
            }
        }
        DNS {
            action drop
            description "https://en.wikipedia.org/wiki/DNS_spoofing    *** THIS SHOULD BE MODIFIED FOR YOUR USE CASE ***"
            ip-protocol udp
            log yes
            rule-number 26
            source {
                ports {
                    domain { }
                }
            }
        }
        SNMPv2 {
            action drop
            description "Simple Network Management Protocol  https://en.wikipedia.org/wiki/Simple_Network_Management_Protocol"
            ip-protocol udp
            log yes
            rule-number 27
            source {
                ports {
                    snmp { }
                    snmptrap { }
                }
            }
        }
        NetBIOS {
            action drop
            description https://en.wikipedia.org/wiki/NetBIOS_over_TCP/IP
            ip-protocol udp
            log yes
            rule-number 28
            source {
                ports {
                    netbios-dgm { }
                    netbios-ns { }
                }
            }
        }
        LDAP {
            action drop
            description https://www.f5.com/labs/articles/threat-intelligence/old-protocols-new-exploits-ldap-unwittingly-serves-ddos-amplification-attacks-22609
            ip-protocol tcp
            log yes
            rule-number 29
            source {
                ports {
                    ldap { }
                }
            }
        }
        MS-SQL {
            action drop
            ip-protocol udp
            log yes
            rule-number 30
            source {
                ports {
                    ms-sql-m { }
                }
            }
        }
        RPC-Bind {
            action drop
            ip-protocol udp
            log yes
            rule-number 31
            source {
                ports {
                    sunrpc { }
                }
            }
        }
        WS-Discovery {
            action drop
            description https://en.wikipedia.org/wiki/WS-Discovery
            ip-protocol udp
            log yes
            rule-number 32
            source {
                ports {
                    hpvmmcontrol { }
                    microsoft-ds { }
                    netbios-ssn { }
                    ws-discovery { }
                }
            }
        }
        ARD {
            action drop
            description "Apple Remote Desktop  https://en.wikipedia.org/wiki/Apple_Remote_Desktop"
            ip-protocol udp
            log yes
            rule-number 33
            source {
                ports {
                    net-assistant { }
                }
            }
        }
        QuickTime_Streaming {
            action drop
            ip-protocol udp
            log yes
            rule-number 34
            source {
                ports {
                    9307 { }
                }
            }
        }
        STUN {
            action drop
            description "https://en.wikipedia.org/wiki/STUN  Also used for PSN - https://manuals.playstation.net/document/en/psvita/psn/firewall.html"
            ip-protocol udp
            log yes
            rule-number 35
            source {
                ports {
                    stun { }
                    twrpc { }
                }
            }
        }
        XBox-Live {
            action drop
            description https://support.xbox.com/en-US/xbox-one/networking/network-ports-used-xbox-live
            ip-protocol udp
            log yes
            rule-number 36
            source {
                ports {
                    ipsec-nat-t { }
                    isakmp { }
                    kerberos { }
                    teredo { }
                    xbox { }
                }
            }
        }
        vision_server {
            action drop
            description http://www.adminsub.net/tcp-udp-port-finder/6672
            ip-protocol udp
            log yes
            rule-number 37
            source {
                ports {
                    vision_server { }
                }
            }
        }
    }
}